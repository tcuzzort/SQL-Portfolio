WITH DailyCalls AS (
    SELECT
        PHONE_CALLER_NAME,
        PHONE_CALLER_ID,
        DATE_TRUNC('DAY', PHONE_CALL_END_PST) AS CALL_DAY,
        COUNT(DISTINCT PHONE_CALL_ID) AS DAILY_CALL_CT,
        COUNT(DISTINCT LEAD_ID) AS DAILY_LEAD_CT
    FROM 
        SINGULARITY.RPT.PHONECALLKM
    WHERE 
        DAYOFWEEK(PHONE_CALL_END_PST) BETWEEN 2 AND 6  -- 2 = Monday, 6 = Friday
    GROUP BY 
        PHONE_CALLER_NAME,
        PHONE_CALLER_ID,
        DATE_TRUNC('DAY', PHONE_CALL_END_PST)
)
, CALL_DETAILS AS (
    SELECT 
        P.LEAD_ID,
        P.PHONE_CALLER_NAME,
        P.PHONE_CALLER_ID,
        DATEDIFF('month', L.CREATED_DATE, CURRENT_DATE) AS LEAD_AGE_MONTHS,
        P.PHONE_CALL_END_PST,
        -- Determine call type based on the first call to each lead by each caller
        CASE
            WHEN P.PHONE_CALL_END_PST IS NULL THEN 'NO_CALL_TIME'
            WHEN P.PHONE_CALL_END_PST = MIN(P.PHONE_CALL_END_PST) OVER (PARTITION BY P.PHONE_CALLER_ID, P.LEAD_ID) 
            THEN 'FIRST_CALL' 
            ELSE 'SUBSEQUENT_CALL' 
        END AS CALL_TYPE
    FROM 
        SINGULARITY.RPT.PHONECALLKM P
    LEFT JOIN 
        SINGULARITY.RPT.LEADKM L ON P.LEAD_ID = L.LEAD_ID
)
, OUTPUT AS (
    SELECT 
        PC.PHONE_CALLER_NAME,
        PC.PHONE_CALLER_ID,
        CASE 
            WHEN PC.PHONE_CALLER_NAME IN ('Carlson, Michael','Houston, Don','Patch, Carolyn','Minton, Don','Tofte, John','Jones, Bobby','Walton, Jill','Voisin, HunterEve','Hill, Grant') 
            THEN 'TOP_PERFORMER' 
            ELSE 'OTHER' 
        END AS TOP_PERFORMERS,
        COUNT(DISTINCT PC.PHONE_CALL_ID) AS PHONE_CALL_TOTAL,
        AVG(COALESCE(DC.DAILY_CALL_CT, 0)) AS AVG_CALLS_PER_WORKDAY,
        AVG(COALESCE(TIMESTAMPDIFF('MINUTE', PC.PHONE_CALL_START_PST, PC.PHONE_CALL_END_PST), 0)) AS AVG_CALL_DURATION_MINUTES,
        AVG(COALESCE(DC.DAILY_LEAD_CT, 0)) AS AVG_LEADS_CALLED_PER_WORKDAY,
        AVG(COALESCE(CD.LEAD_AGE_MONTHS, 0)) AS AVG_LEAD_AGE_MONTHS,
        COALESCE(CD.CALL_TYPE, 'NO_CALL_TIME') AS CALL_TYPE
    FROM 
        SINGULARITY.RPT.PHONECALLKM PC
    LEFT JOIN 
        DailyCalls DC ON PC.PHONE_CALLER_NAME = DC.PHONE_CALLER_NAME
        AND DATE_TRUNC('DAY', PC.PHONE_CALL_END_PST) = DC.CALL_DAY
    LEFT JOIN
        CALL_DETAILS CD ON PC.PHONE_CALLER_ID = CD.PHONE_CALLER_ID 
        AND PC.LEAD_ID = CD.LEAD_ID
        AND PC.PHONE_CALL_END_PST = CD.PHONE_CALL_END_PST  -- Join on exact call timestamp to match CALL_TYPE correctly
    GROUP BY 
        PC.PHONE_CALLER_NAME,
        PC.PHONE_CALLER_ID,
        COALESCE(CD.CALL_TYPE, 'NO_CALL_TIME')
)
SELECT *
FROM OUTPUT;

--- Validation, total phone call count ---
SELECT COUNT(DISTINCT PHONE_CALL_ID)
FROM SINGULARITY.RPT.PHONECALLKM;

--- Validation, specific PHONE_CALLER_ID cases ---
SELECT *
FROM SINGULARITY.RPT.PHONECALLKM
WHERE PHONE_CALLER_ID = 
--'7F467BA1-3AA9-E311-95D5-00188B3FB15C' --Other--
'B90BBF36-24D1-E611-AFED-00188B3FB15C' -- Top Performer--
;
